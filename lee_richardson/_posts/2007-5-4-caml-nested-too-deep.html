--- 
permalink: /blogs/lee_richardson/caml_nested_too_deep.html
layout: blogs
title: "CAML: Nested Too Deep"
date: 2007-05-04 13:04:38 -04:00
tags: .NET
---
<p>I discovered an interesting error recently while working with Microsoft's Collaborative Application Markup Language (CAML) that, surprisingly, had received no ink. Partly what surprises me about this is that the error may require you to rewrite large sections of your code if you haven't previously considered this SharePoint limitation. I'll start with some context, but first of all the error is: </p>
<p>"Some part of your SQL statement is nested too deeply. Rewrite the query or break it up into smaller queries," </p>
<div style="FLOAT: right; MARGIN-LEFT: 10px">
<script type="text/javascript">
        var currentPageUrl = 'http://rapidapplicationdevelopment.blogspot.com/2007/05/caml-nested-too-deep.html';

        /* Digg */
        var diggIframe = document.createElement('iframe');
        diggIframe.setAttribute('src', 'http://digg.com/tools/diggthis.php?u=' + currentPageUrl);
        diggIframe.setAttribute('height', '80');
        diggIframe.setAttribute('width', '52');
        diggIframe.setAttribute('frameborder', '0');
        diggIframe.setAttribute('scrolling', 'no');
        
        /* Reddit */
        var redditIframe = document.createElement('iframe');
        redditIframe.setAttribute('src', 'http://reddit.com/button?t=2&url=' + currentPageUrl);
        redditIframe.setAttribute('height', '80');
        redditIframe.setAttribute('width', '52');
        redditIframe.setAttribute('frameborder', '0');
        redditIframe.setAttribute('scrolling', 'no');

        /* DotNetKicks */
        var dotnetkicksLink = document.createElement('a');
        dotnetkicksLink.setAttribute('href', 'http://www.dotnetkicks.com/kick/?url=' + currentPageUrl);
        var dotnetkicksImg = document.createElement('img');
        dotnetkicksImg.setAttribute('src', 'http://www.dotnetkicks.com/Services/Images/KickItImageGenerator.ashx?url=' + currentPageUrl);
        dotnetkicksImg.setAttribute('alt', 'Kick this article (a good thing) on DotNetKicks');
        dotnetkicksImg.setAttribute('border', '0');
        dotnetkicksImg.setAttribute('style', 'margin-left:auto; margin-right:auto; display:block; text-align:center;');
        dotnetkicksLink.appendChild(dotnetkicksImg);

        var div = document.createElement('div');
        div.appendChild(diggIframe);
        div.appendChild(redditIframe);
        div.appendChild(document.createElement('br'));
        div.appendChild(document.createElement('br'));
        div.appendChild(dotnetkicksLink);

        document.write(div.innerHTML);
    </script>
</div>
<p>So let's back up and describe what CAML is for everyone who isn't yet experiencing this problem.</p>
<p>CAML is an XML based query language that is similar to, and serves many of the same purposes as SQL and DDL. However, CAML is used primarily to interact with SharePoint lists. You can retrieve data using something like:</p><span style="FONT-SIZE: 9pt; COLOR: #a31515; FONT-FAMILY: 'Courier New'; mso-bidi-font-size: 10.0pt; mso-fareast-font-family: 'Times New Roman'; mso-fareast-theme-font: minor-fareast; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA; mso-no-proof: yes">&lt;Where&gt;&lt;Eq&gt;&lt;FieldRef Name='Title'/&gt;&lt;Value Type='Text'&gt;hello&lt;/Value&gt;&lt;/Eq&gt;&lt;/Where&gt;</span>
<p></p>
<p>Which is equilivant to WHERE Title = "hello" in a SQL statement. At this point I'm sure you're asking why exchange 80 characters for 21? I suppose the answer is related to how CAML is primarily used in web services requests. Regardless, the nested too deeply error occurs when you try to insert large amounts of data into a list.</p>
<p>The insert syntax is actually all batch based, so if you have 100 list items to insert into a list, you build them all into one big CAML statement and then send it across the wire with a call to <a href="http://msdn2.microsoft.com/en-us/library/lists.lists.updatelistitems.aspx" target="_blank">Lists.UpdateListItems()</a>. Your CAML statement will look something like the following:</p>
<div style="FONT-FAMILY: 'Courier New'"><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">Batch</span> OnError="Continue"&gt;<br /><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">Method</span> ID="1" Cmd="New"<span style="COLOR: blue">&gt;<br /></span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">Field</span> Name="Title"<span style="COLOR: blue">&gt;</span>Hello<span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">Field</span><span style="COLOR: blue">&gt;<br /></span>&nbsp; &nbsp; &nbsp; &nbsp;<span style="mso-spacerun: yes"> </span><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">Field</span> Name="Document"<span style="COLOR: blue">&gt;5&lt;/</span><span style="COLOR: maroon">Field</span><span style="COLOR: blue">&gt;<br /></span><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: blue">&lt;/</span><span style="COLOR: maroon">Method</span><span style="COLOR: blue">&gt;<br /></span><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">Method</span> ID="2" Cmd="New"<span style="COLOR: blue">&gt;<br /></span>&nbsp; &nbsp; &nbsp; &nbsp;<span style="mso-spacerun: yes"> </span><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">Field</span> Name="Title" <span style="COLOR: blue">&gt;</span>World<span style="COLOR: blue">&lt;/</span><span style="COLOR: maroon">Field</span><span style="COLOR: blue">&gt;<br /></span>&nbsp; &nbsp; &nbsp; &nbsp;<span style="mso-spacerun: yes"> </span><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">Field</span> Name="Document"<span style="COLOR: blue">&gt;5&lt;/</span><span style="COLOR: maroon">Field</span><span style="COLOR: blue">&gt;<br /></span><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: blue">&lt;/</span><span style="COLOR: maroon">Method</span><span style="COLOR: blue">&gt;<br /></span><span style="COLOR: blue">&lt;/</span><span style="COLOR: maroon">Batch</span><span style="COLOR: blue">&gt;<?xml namespace="" ns="urn:schemas-microsoft-com:office:office"        prefix="o" ?><o:p></o:p></span></div>
<p>The problem comes when you want to insert something like 19,642 list items into a list. SharePoint complains with "Some part of your SQL statement is nested too deeply. Rewrite the query or break it up into smaller queries," and suddenly you're stuck with an enormous CAML statement that you need to break up into smaller batches. How small? Well, for me 300 worked and 500 didn't, so I set my batch size to 300.</p>
<p>This means that if you are currently experiencing this problem, then have fun rewriting your code to use smaller batches. And, if you're lucky enough to be reading this before you experience the error, then prepare yourself now for this possibility. </p>
<p>Or, if performance isn't an issue and you don't want to or can't rewrite the code that built your CAML then feel free to use this code to batch up CAML batches into smaller batches.</p>
<div class="LeeCodeCAML">
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> </span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;summary&gt;<?xml namespace="" ns="urn:schemas-microsoft-com:office:office"
                            prefix="o" ?><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> Breaks a larg CAML query into smaller batches to avoid the error "Some part of your SQL statement is nested too deeply. Rewrite the query or break it up into smaller queries."<?xml namespace="" ns="urn:schemas-microsoft-com:office:office"
                        prefix="o" ?><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> </span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;/summary&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> </span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;param name="listService"&gt;</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">The SharePoint list service to execute the CAML against.</span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;/param&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> </span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;param name="strListName"&gt;</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">The name of the list to execute the CAML against.</span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;/param&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> </span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;param name="elementLargeBatch"&gt;</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">The CAML batch list of commands to be broken up.</span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;/param&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> </span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;param name="intBatchSize"&gt;</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">The size of batches to use.<span style="mso-spacerun: yes">&nbsp; </span>If unsure use 300, it seems to work fairly well.</span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;/param&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">///</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> </span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;returns&gt;</span><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">The results of all batched queries.</span><span style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">&lt;/returns&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">public</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> <span style="COLOR: blue">static</span> <span style="COLOR: #2b91af">XmlNode</span> ExecuteLargeQuery(<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: #2b91af">Lists</span> listService, <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: blue">string</span> strListName, <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: #2b91af">XmlElement</span> elementLargeBatch,<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: blue">int</span> intBatchSize<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span>) {<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: green">// calculate useful information<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: blue">int</span> intMethodCount = elementLargeBatch.ChildNodes.Count;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: blue">int</span> intBatchCount = (<span style="COLOR: blue">int</span>)<span style="COLOR: #2b91af">Math</span>.Ceiling((<span style="COLOR: blue">double</span>)intMethodCount / (<span style="COLOR: blue">double</span>)intBatchSize);<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: green">// prepare xml documents for batches and results<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: #2b91af">XmlDocument</span> xmlDocBatch = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">XmlDocument</span>();<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: #2b91af">XmlDocument</span> xmlDocResults = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">XmlDocument</span>();<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: #2b91af">XmlElement</span> elementResults = xmlDocResults.CreateElement(<span style="COLOR: #a31515">"Results"</span>);<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: green">// for each batch<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: blue">for</span> (<span style="COLOR: blue">int</span> intCurrentBatch = 0; intCurrentBatch &lt; intBatchCount; intCurrentBatch++) {<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: blue">int</span> intMethodStart = intCurrentBatch * intBatchSize;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: blue">int</span> intMethodEnd = <span style="COLOR: #2b91af">Math</span>.Min(intMethodStart + intBatchSize - 1, intMethodCount - 1);<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: #2b91af">XmlElement</span> elementSmallBatch = <span style="COLOR: #2b91af">ListHelper</span>.CreateBatch(xmlDocBatch);<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: green">// for each method in the batch<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: blue">for</span> (<span style="COLOR: blue">int</span> intCurrentMethod = intMethodStart; intCurrentMethod &lt;= intMethodEnd; intCurrentMethod++) {<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: #2b91af">XmlElement</span> element = (<span style="COLOR: #2b91af">XmlElement</span>)elementLargeBatch.ChildNodes[intCurrentMethod];<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>elementSmallBatch.AppendChild(xmlDocBatch.ImportNode(element, <span style="COLOR: blue">true</span>));<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span>}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: green">// execute the batch<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: #2b91af">XmlNode</span> nodeBatchResult = listService.UpdateListItems(strListName, elementSmallBatch);<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: green">// add the results of the batch into the results xml document<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: blue">foreach</span> (<span style="COLOR: #2b91af">XmlElement</span> elementResult <span style="COLOR: blue">in</span> nodeBatchResult.ChildNodes)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>elementResults.AppendChild(xmlDocResults.ImportNode(elementResult, <span style="COLOR: blue">true</span>));<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; </span><span style="mso-spacerun: yes">&nbsp; </span><span style="COLOR: green">// clean up<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; &nbsp; &nbsp; </span>xmlDocBatch.RemoveAll();<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span>}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o:p>&nbsp;</o:p> &nbsp; &nbsp; </span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: blue">return</span> elementResults;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">}<o:p></o:p></span></p></div>
<p><b>Useful MSDN References</b></p>
<p>Incidentally, these MSDN references might be useful if you're interested in more info:</p>
<p><a href="http://msdn2.microsoft.com/en-us/library/ms426449.aspx" target="_blank">Introduction to Collaborative Application Markup Language (CAML)</a></p>
<p><a href="http://msdn2.microsoft.com/en-us/library/ms467521.aspx" target="_blank">CAML Reference: Query Schema</a></p>
<p><a href="http://msdn2.microsoft.com/en-us/library/ms437562.aspx" target="_blank">CAML Reference: Batch Element</a></p> 
