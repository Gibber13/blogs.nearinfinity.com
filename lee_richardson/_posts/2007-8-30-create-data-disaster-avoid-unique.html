--- 
permalink: /blogs/create_data_disaster_avoid_unique.html
layout: blogs
title: "Create Data Disaster: Avoid Unique Indexes (Mistake 3 of 10)"
date: 2007-08-30 19:54:53 -04:00
tags: General SQL
---
<p>I really enjoyed <a href="http://www.nearinfinity.com/blogs/page/seths" dtid="1125899906842629">Seth Schroeder</a>'s <a href="http://www.nearinfinity.com/blogs/page/lrichard?entry=surrogate_keys_data_modeling_mistake#comment1" dtid="1125899906842630">critique</a> of the last post in my ten part data modeling mistake series: <a href="editor-content.html??" dtid="1125899906842631">Surrogate vs Natural Primary Keys</a>. His argument regarding data migration in particular sheds light on a major shortcoming of using surrogate keys: they lead data modelers to a false sense of security regarding the uniqueness of data. Specifically if modelers ignore uniqueness constraints they allow duplicate data. And as Seth points out this has a nasty side effect of disallowing any clear way to compare data between systems. But there are other problems too.</p>
<div style="FLOAT: right; MARGIN-LEFT: 10px">
<script type="text/javascript">
        var currentPageUrl = 'http://rapidapplicationdevelopment.blogspot.com/2007/08/create-data-disaster-avoid-unique.html';

        /* Digg */
        var diggIframe = document.createElement('iframe');
        diggIframe.setAttribute('src', 'http://digg.com/tools/diggthis.php?u=' + currentPageUrl);
        diggIframe.setAttribute('height', '80');
        diggIframe.setAttribute('width', '52');
        diggIframe.setAttribute('frameborder', '0');
        diggIframe.setAttribute('scrolling', 'no');
        diggIframe.setAttribute('style', 'margin-left:auto; margin-right:auto; display:block; text-align:center;');

        /* DotNetKicks */
        var dotnetkicksLink = document.createElement('a');
        dotnetkicksLink.setAttribute('href', 'http://www.dotnetkicks.com/kick/?url=' + currentPageUrl);
        var dotnetkicksImg = document.createElement('img');
        dotnetkicksImg.setAttribute('src', 'http://www.dotnetkicks.com/Services/Images/KickItImageGenerator.ashx?url=' + currentPageUrl);
        dotnetkicksImg.setAttribute('alt', 'Kick this article (a good thing) on DotNetKicks');
        dotnetkicksImg.setAttribute('border', '0');
        dotnetkicksImg.setAttribute('style', 'margin-left:auto; margin-right:auto; display:block; text-align:center;');
        dotnetkicksLink.appendChild(dotnetkicksImg);

        var div = document.createElement('div');
        div.appendChild(diggIframe);
        div.appendChild(document.createElement('br'));
        div.appendChild(dotnetkicksLink);

        document.write(div.innerHTML);
    </script>
</div>
<p dtid="1125899906842632">So, in this post I'll address the uniqueness problem introduced with surrogate keys by way of an example, I'll provide two how-to's, one implementing uniqueness in Visio and one in NHibernate, I'll explain the difference between unique indexes and unique constraints, and finally I'll provide reasons why unique indexes might be overlooked, specifically by providing a critique of ORM tools.</p>
<p dtid="1125899906842633"><b dtid="1125899906842634">Surrogate Keys = Data Disaster?</b></p>
<p dtid="1125899906842635">So as mentioned above the biggest problem with surrogate keys is they lull junior data modelers or lazy developers into thinking they don't need to worry about indexes. But they do; and it's as vital as implementing <a href="http://rapidapplicationdevelopment.blogspot.com/2007/07/referential-integrity-data-modeling.html" dtid="1125899906842636">referential integrity</a>. And for the same reason: data integrity.</p>
<p dtid="1125899906842637">As an example, imagine you're modeling a simple <i dtid="1125899906842638">Country</i> table. You could of course use CountryName as the primary key, but as you know from my post on <a href="http://rapidapplicationdevelopment.blogspot.com/2007/08/in-case-youre-new-to-series-ive.html" dtid="1125899906842639">surrogate keys</a>, you would have problems with varchar join speed (assuming you disagree with Seth that it's a premature optimization) and to a lesser extent cascading updates (since country names do occasionally change).</p>
<p dtid="1125899906842640"><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://bp2.blogger.com/_gez10dNhuPk/RtdLjeB8eiI/AAAAAAAAAKE/dQr8OWfacPQ/s1600-h/01+-+Still+Bad.jpg" dtid="1125899906842641"><img id="BLOGGER_PHOTO_ID_5104631775376472610" alt="" src="http://bp2.blogger.com/_gez10dNhuPk/RtdLjeB8eiI/AAAAAAAAAKE/dQr8OWfacPQ/s400/01+-+Still+Bad.jpg" border="0" dtid="1125899906842642" /></a></p>
<p dtid="1125899906842643">Introducing a surrogate key (CountryId) resolves these issues, but you also remove an inherent advantage that natural keys have: they require uniqueness in country names. In other words you can now have two New Zealand's and the system wouldn't stop you.</p>
<p dtid="1125899906842644">What's the big deal? <i dtid="1125899906842645">Country</i> seems like a pretty benign table to have duplicates, right? Your users from New Zealand simply have an extra list item in their drop down to pick from and some pick one and some pick the other. </p>
<p dtid="1125899906842646">For <i dtid="1125899906842647">Country</i> one problem comes in reporting. Consider delivering a revenue by <i dtid="1125899906842648">Country</i> report. Your report probably lists New Zealand twice and a quick scan by an exec sees half of the actual revenue for that country that they should. And as a result numerous innocent sheep are slaughtered&nbsp;... uh, or something.</p>
<p dtid="1125899906842649">Another major problem could come in syncing data with other systems. How do those systems know which record to use?</p>
<p dtid="1125899906842650">As you can imagine the problem is even worse with major entities like Customer, Order, Product, or something more scary like Airline Flights. And the longer the system stays in production, the more production data the system collects, the more duplicates rack up, and the more time and money that will be required to clean up the data when the problem is finally identified. In short the bigger the data disaster.</p>
<p dtid="1125899906842651"><b dtid="1125899906842652">How To #1: Visio</b></p>
<p dtid="1125899906842653">So the solution is to add at least one unique constraint (or index) to every single table. In other words if you have a table without a uniqueness constraint chances are very good you''ve done something wrong.</p>
<p dtid="1125899906842654">The good news is that it's pretty easy to implement once you agree it's necessary. If you're modeling with Microsoft Visio this is a six step process:</p>
<p dtid="1125899906842655"><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://bp2.blogger.com/_gez10dNhuPk/RtdLjeB8ejI/AAAAAAAAAKM/KWTH3-60ixY/s1600-h/02+-+Visio+How+To.jpg" dtid="1125899906842656"><img id="Img1" alt="" src="http://bp2.blogger.com/_gez10dNhuPk/RtdLjeB8ejI/AAAAAAAAAKM/KWTH3-60ixY/s400/02+-+Visio+How+To.jpg" border="0" dtid="1125899906842657" /></a></p>
<ol dtid="1125899906842658">
<li dtid="1125899906842659">Select the table. </li>
<li dtid="1125899906842660">Select the "Indexes" category. </li>
<li dtid="1125899906842661">Click New. </li>
<li dtid="1125899906842662">No need to enter a name, just click OK. </li>
<li dtid="1125899906842663">Select either "Unique constraint only" or "Unique index only" (more on this decision later). </li>
<li dtid="1125899906842664">Double click the column(s) to add. </li></ol>
<p dtid="1125899906842665">Then when you generate or update your database Visio puts in DBMS specific uniqueness constraints. And voila, problem solved.</p>
<p dtid="1125899906842666"><b dtid="1125899906842667">Unique Constraints vs Unique Indexes</b></p>
<p dtid="1125899906842668">The question will come up when using Visio or perhaps using various DBMS's including SQL Server whether to use a unique constraint or unique index. The short answer is that most people use unique constraints, but ultimately they're the same thing so it doesn't matter. </p>
<p dtid="1125899906842669">In case you're interested in the details though here's a quick rundown of the differences:</p>
<p dtid="1125899906842670">Unique Constraint</p>
<ul dtid="1125899906842671">
<li dtid="1125899906842672">A logical construct. </li>
<li dtid="1125899906842673">Defined in the ANSI SQL standard. </li>
<li dtid="1125899906842674">Intent: data integrity. </li>
<li dtid="1125899906842675">Usually part of a table definition. </li></ul>
<p dtid="1125899906842676">Unique Index</p>
<ul dtid="1125899906842677">
<li dtid="1125899906842678">A physical DBMS implementation. </li>
<li dtid="1125899906842679">Not specified in ANSI SQL. </li>
<li dtid="1125899906842680">Intent: performance. </li>
<li dtid="1125899906842681">Usually external to a table definition. </li></ul>
<p dtid="1125899906842682">But since most DBMS's implement unique constraints as unique indexes, it doesn't really matter which you choose.</p>
<p dtid="1125899906842683"><b dtid="1125899906842684">How To #2: NHibernate</b></p>
<p dtid="1125899906842685">Since I have the pleasure of learning the NHibernate ORM tool on my current project, I thought I'd also describe the same technique with a different tool. Basically you can either set the Unique attribute to true to obtain uniqueness in one column, or set the <a href="http://blog.benday.com/archive/2006/04/02/4007.aspx" dtid="1125899906842686">unique-key attribute</a> to obtain uniqueness among multiple columns. If you use NHibernate <a href="http://www.hibernate.org/hib_docs/nhibernate/html/mapping-attributes.html" dtid="1125899906842687">mapping attributes</a> you write:</p><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'" dtid="1125899906842688">
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal" dtid="1125899906842689"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'" dtid="1125899906842690">[<span style="COLOR: rgb(43,145,175)" dtid="1125899906842691">Property</span>(NotNull = <span style="COLOR: blue" dtid="1125899906842692">true</span>, Length = 100, Unique = <span style="COLOR: blue" dtid="1125899906842693">true</span>)]<o:p dtid="1125899906842694"></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal" dtid="1125899906842695"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'" dtid="1125899906842696">public</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'" dtid="1125899906842697"> <span style="COLOR: blue" dtid="1125899906842698">virtual</span> <span style="COLOR: blue" dtid="1125899906842699">string</span> CountryName {<o:p dtid="1125899906842700"></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal" dtid="1125899906842701"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'" dtid="1125899906842702"><span dtid="1125899906842703"></span><span style="COLOR: blue" dtid="1125899906842704">&nbsp;&nbsp;&nbsp;&nbsp;get</span> { <span style="COLOR: blue" dtid="1125899906842705">return</span> _strCountryName; }<o:p dtid="1125899906842706"></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal" dtid="1125899906842707"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'" dtid="1125899906842708"><span dtid="1125899906842709"></span><span style="COLOR: blue" dtid="1125899906842710">&nbsp;&nbsp;&nbsp;&nbsp;set</span> { _strCountryName = <span style="COLOR: blue" dtid="1125899906842711">value</span>; }<o:p dtid="1125899906842712"></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal" dtid="1125899906842713"><span style="FONT-SIZE: 10pt; LINE-HEIGHT: 115%; FONT-FAMILY: 'Courier New'" dtid="1125899906842714">}</span><span style="FONT-SIZE: 11pt; LINE-HEIGHT: 115%; FONT-FAMILY: 'Calibri','sans-serif'" dtid="1125899906842715"> </span></p></span>
<p dtid="1125899906842718">Which generates the following hbm:</p><span class="m1"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; LINE-HEIGHT: 115%; FONT-FAMILY: 'Verdana','sans-serif'; mso-fareast-font-family: Calibri; mso-fareast-theme-font: minor-latin; mso-bidi-font-family: 'Times New Roman'; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA">&lt;</span></span><span class="t1"><span style="FONT-SIZE: 10pt; COLOR: #990000; LINE-HEIGHT: 115%; FONT-FAMILY: 'Verdana','sans-serif'; mso-fareast-font-family: Calibri; mso-fareast-theme-font: minor-latin; mso-bidi-font-family: 'Times New Roman'; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA">class name</span></span><span class="m1"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; LINE-HEIGHT: 115%; FONT-FAMILY: 'Verdana','sans-serif'; mso-fareast-font-family: Calibri; mso-fareast-theme-font: minor-latin; mso-bidi-font-family: 'Times New Roman'; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA">="</span></span><b><span style="FONT-SIZE: 10pt; LINE-HEIGHT: 115%; FONT-FAMILY: 'Verdana','sans-serif'; mso-fareast-font-family: Calibri; mso-fareast-theme-font: minor-latin; mso-bidi-font-family: 'Times New Roman'; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA">Country</span></b><span class="m1"><span style="FONT-SIZE: 10pt; COLOR: #0000ff; LINE-HEIGHT: 115%; FONT-FAMILY: 'Verdana','sans-serif'; mso-fareast-font-family: Calibri; mso-fareast-theme-font: minor-latin; mso-bidi-font-family: 'Times New Roman'; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA">"&gt;</span></span><span style="FONT-SIZE: 10pt; LINE-HEIGHT: 115%; FONT-FAMILY: 'Verdana','sans-serif'; mso-fareast-font-family: Calibri; mso-fareast-theme-font: minor-latin; mso-bidi-font-family: 'Times New Roman'; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA"><br /><span class="m1"><span style="COLOR: #0000ff; mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: #0000ff">&lt;</span></span><span class="t1" style="COLOR: #990000">id name</span><span class="m1" style="COLOR: #0000ff">="</span><b>CountryId</b><span class="m1" style="COLOR: #0000ff">"&gt;&lt;</span><span class="t1" style="COLOR: #990000">generator</span> <span class="t1" style="COLOR: #990000">class</span><span class="m1" style="COLOR: #0000ff">="</span><b>sequence</b><span class="m1" style="COLOR: #0000ff">" /&gt;&lt;/</span><span class="t1" style="COLOR: #990000">id</span><span style="COLOR: #0000ff"><span class="m1">&gt;</span><br /></span><span class="m1"><span style="COLOR: #0000ff; mso-spacerun: yes">&nbsp; &nbsp; </span><span style="COLOR: #0000ff">&lt;</span></span><span class="t1" style="COLOR: #990000">property</span> <span class="t1" style="COLOR: #990000">name</span><span class="m1" style="COLOR: #0000ff">="</span><b>CountryName</b><span class="m1" style="COLOR: #0000ff">"</span><span class="t1" style="COLOR: #990000"> length</span><span class="m1" style="COLOR: #0000ff">="</span><b>100</b><span class="m1" style="COLOR: #0000ff">"</span><span class="t1" style="COLOR: #990000"> not-null</span><span class="m1" style="COLOR: #0000ff">="</span><b>true</b><span class="m1" style="COLOR: #0000ff">"</span><span class="t1" style="COLOR: #990000"> unique</span><span class="m1" style="COLOR: #0000ff">="</span><b>true</b><span style="COLOR: #0000ff"><span class="m1">" /&gt;</span><br /></span><span class="m1" style="COLOR: #0000ff">&lt;/</span><span class="t1" style="COLOR: #990000">class</span><span class="m1" style="COLOR: #0000ff">&gt;</span></span> 
<p dtid="1125899906842786">Which NHibernate turns into the following DDL:</p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">create</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> <span style="COLOR: blue">table</span> Country <span style="COLOR: gray">(<?xml namespace="" ns="urn:schemas-microsoft-com:office:office" prefix="o" ?><o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>CountryId NUMBER<span style="COLOR: gray">(</span>10<span style="COLOR: gray">,</span>0<span style="COLOR: gray">)</span> <span style="COLOR: gray">not</span> <span style="COLOR: gray">null,<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>CountryName NVARCHAR2<span style="COLOR: gray">(</span>100<span style="COLOR: gray">)</span> <span style="COLOR: gray">not</span> <span style="COLOR: gray">null</span> <span style="COLOR: gray">&lt;</span>b<span style="COLOR: gray">&gt;</span><span style="COLOR: blue">unique</span><span style="COLOR: gray">&lt;/</span>b<span style="COLOR: gray">&gt;,<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: blue">primary</span> <span style="COLOR: blue">key</span> <span style="COLOR: gray">(</span>CountryId<span style="COLOR: gray">)<o:p></o:p></span></span></p><span style="FONT-SIZE: 10pt; COLOR: gray; LINE-HEIGHT: 115%; FONT-FAMILY: 'Courier New'; mso-fareast-font-family: Calibri; mso-fareast-theme-font: minor-latin; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA; mso-no-proof: yes">)</span> 
<p>So quick quiz: was that a unique index or unique constraint it generated? If you answered who cares you're right. However if you answered a unique constraint you're also right.</p>
<p dtid="1125899906842848"><b dtid="1125899906842849">The Problem with ORM</b></p>
<p dtid="1125899906842850">Obviously ignorance of the problem and shortsightedness are two causes for systems going into production without unique indexes, but I'd like to point out a third. While Object Relational Mapping (ORM) tools like NHibernate are extremely convenient for generating database schemas, modeling database tables with classes and generating DDL can lead developers to a false sense of purpose.</p>
<p dtid="1125899906842851">This can occur because ORM tools focus entirely on the world of objects and classes. In this world data's persistence is irrelevant. It exists for the purposes of a single operation, and consequently long term data persistence issues like data integrity are deemphasized. In fact, it would be easy to lose perspective of the fact that there is a database at all.</p>
<p dtid="1125899906842852">Don't get me wrong, the benefits you get like mandatory surrogate keys, DBMS neutrality, lazy loading, and minimal data access code are wonderful. Just don't forget that tags like NHibernate's <i dtid="1125899906842853">unique</i> and <i dtid="1125899906842854">unique-key</i> exist. And are very necessary.</p>
<p dtid="1125899906842855"><b dtid="1125899906842856">Conclusion</b></p>
<p dtid="1125899906842857">To sum it up don't allow the convenience of surrogate keys to lull you into a false sense of security regarding the importance of keys. It's a trap. And it will be a disastrous one if you aren't careful.</p> 
