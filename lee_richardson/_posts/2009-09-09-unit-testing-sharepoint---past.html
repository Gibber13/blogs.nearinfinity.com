---
atom_id: tag:www.nearinfinity.com,2009:/blogs//7.765 # This is for backwards compatibility do not change!
permalink: /blogs/lee_richardson/unit_testing_sharepoint_-_past.html
layout: blogs
title: Unit Testing SharePoint - Past, Present, and Sporm
date: 2009-09-09 15:44:18 -04:00
tags: .NET
---
<p>As I described in <a href=" http://rapidapplicationdevelopment.blogspot.com/2009/08/sharepoint-wild-west-of-software.html">SharePoint: The Wild West of Software Development</a> there is a serious problem when you develop for SharePoint: ensuring quality through unit testing is really, really hard.  And that's where a new open source tool just released today called <a href=" http://sporm.codeplex.com/ ">sporm</a> (SharePoint Object Relational Mapper) comes in.  While sporm provides many benefits besides simplified unit testing I wanted to focus on this topic first, because sporm's approach, which models the <a href="http://msdn.microsoft.com/en-us/library/aa697427(VS.80).aspx">entity framework</a> in the way it supports POCO's, is a unique feature not available with other SharePoint tools like LINQ to SharePoint.</p>

<div style='float:right; margin-left:10px;'>
<script type='text/javascript'>
        var currentPageUrl = 'http://rapidapplicationdevelopment.blogspot.com/2009/09/unit-testing-sharepoint-past-present.html';
 
        /* Digg */
        var diggIframe = document.createElement('iframe');
        diggIframe.setAttribute('src', 'http://digg.com/tools/diggthis.php?u=' + currentPageUrl);
        diggIframe.setAttribute('height', '80');
        diggIframe.setAttribute('width', '52');
        diggIframe.setAttribute('frameborder', '0');
        diggIframe.setAttribute('scrolling', 'no');
        diggIframe.setAttribute('style', 'margin-left:auto; margin-right:auto; display:block; text-align:center;');
 
        /* DotNetKicks */
        var dotnetkicksLink = document.createElement('a');
        dotnetkicksLink.setAttribute('href', 'http://www.dotnetkicks.com/kick/?url=' + currentPageUrl);
        var dotnetkicksImg = document.createElement('img');
        dotnetkicksImg.setAttribute('src', 'http://www.dotnetkicks.com/Services/Images/KickItImageGenerator.ashx?url=' + currentPageUrl);
        dotnetkicksImg.setAttribute('alt', 'Kick this article (a good thing) on DotNetKicks');
        dotnetkicksImg.setAttribute('border', '0');
        dotnetkicksImg.setAttribute('style', 'margin-left:auto; margin-right:auto; display:block; text-align:center;');
        dotnetkicksLink.appendChild(dotnetkicksImg);
 
        var div = document.createElement('div');
        div.appendChild(dotnetkicksLink);
        div.appendChild(document.createElement('br'));
        div.appendChild(diggIframe);
 
        document.write(div.innerHTML);
    </script>
</div>

<p>I'll start by describing the unit testing problem, then provide a conventional solution with mocking, then finish with the elegance of a sporm based solution.</p>

<p><b>Simple Unit Testing Turns Ugly</b></p>

<p>I would bet anyone that attempts to develop a tiered solution with SharePoint ends up with entities that look something like this:</p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:normal;mso-layout-grid-align:none;text-autospace:none">        <span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;color:blue;mso-no-proof:yes">public</span><span             style="font-size:10.0pt;font-family:&quot;Courier New&quot;;mso-no-proof:yes">        <span style="color:blue">class</span> <span style="color:#2B91AF">Employee</span>         {<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:blue">public</span> <span style="color:#2B91AF">SPListItem</span>         ListItem { <span style="color:blue">get</span>; <span style="color:blue">private</span>        <span style="color:blue">set</span>; }<br />        <br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> </span>        <span style="color:gray">&lt;summary&gt;<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> The constructor         requires that you pass in a list item        <br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> that is used by         your strongly typed properties<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> </span>        <span style="color:gray">&lt;/summary&gt;<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:blue">public</span> Employee(<span style="color:#2B91AF">SPListItem</span>         listItem) {<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </span>ListItem = listItem;<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br />        <br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> </span>        <span style="color:gray">&lt;summary&gt;<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> This provides your         entities strong typing to hide        <br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> the native weak         typing in SharePoint<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:gray">///</span><span style="color:green"> </span>        <span style="color:gray">&lt;/summary&gt;<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="color:blue">public</span> <span style="color:blue">virtual</span>        <span style="color:blue">string</span> LastName {<br />      <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </span><span style="color:blue">get</span> { <span style="color:blue">return</span>         (<span style="color:blue">string</span>)ListItem[<span style="color:#A31515">&quot;LastName&quot;</span>];         }<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        </span><span style="color:blue">set</span> { ListItem[<span             style="color:#A31515">&quot;LastName&quot;</span>] = <span style="color:blue">value</span>;         }<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br />        }<br style="mso-special-character:line-break" />        <![if !supportLineBreakNewLine]>        <br style="mso-special-character:line-break" />        <![endif]><o:p></o:p></span>    </p>

<p>And if you have some function that you'd like to unit test like this:</p>

<p>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:gray;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">///</span><span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:green;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> </span>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:gray;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">&lt;summary&gt;<br />        ///</span><span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:green;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> Typically returns &quot;[LastName], [FirstName]&quot; but skips        <br />        </span>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:gray;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">///</span><span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:green;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> the comma if either is missing<br />        </span>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;o-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:gray;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">///</span><span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:green;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> </span>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:gray;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">&lt;/summary&gt;<br />        </span>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:blue;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">public</span><span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> <span style="color:blue">string</span> GetNameFormatted() {<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">bool</span>         noFirst = <span style="color:blue">string</span>.IsNullOrEmpty(FirstName);<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">bool</span>         noLast = <span style="color:blue">string</span>.IsNullOrEmpty(LastName);<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span>         (noFirst &amp;&amp; noLast) <span style="color:blue">return</span>        <span style="color:#A31515">&quot;&quot;</span>;<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span>         (noFirst) <span style="color:blue">return</span> LastName;<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span>         (noLast) <span style="color:blue">return</span> FirstName;<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span>        <span style="color:blue">string</span>.Format(<span style="color:#A31515">&quot;{0},         {1}&quot;</span>, LastName, FirstName);<br />        }<br />        <br style="mso-special-character:line-break" />        <![if !supportLineBreakNewLine]>        <br style="mso-special-character:line-break" />        <![endif]></span>    </p>

<p>Now you face a major problem: LastName is tightly coupled with SPListItem.  And SPListItem only contains internal constructors making it unmockable.  So if you keep the tight coupling and pass an SPListItem into the constructor then you need a connection to SharePoint and an employee list (table) and you need to create an employee list item (record), then you test it, and finally you ought to clean up after yourself and delete the list item.  Talk about a simple unit test turned fragile integration test.  Yuck.</p>

<p><b>Mocking the Solution</b></p>

<p>So at this point you're undoubtedly thinking it's time to mock.  To do this you'll have to make a public constructor that takes no arguments and mark your properties virtual.  Then you can write a test like this:</p>

<p>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">[<span style="color:#2B91AF">TestMethod</span>]<br />        <span style="color:blue">public</span> <span style="color:blue">void</span>         TestGetNameFormatted_FirstAndLastExist_LastCommaFirst() {<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2B91AF">        MockRepository</span> mocks = <span style="color:blue">new</span>        <span style="color:#2B91AF">MockRepository</span>();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2B91AF">Employee</span>         mockEmployee = mocks.StrictMock&lt;<span style="color:#2B91AF">Employee</span>&gt;();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2B91AF">Expect</span>.Call(mockEmployee.FirstName).Return(<span             style="color:#A31515">&quot;Lee&quot;</span>).Repeat.Any();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2B91AF">Expect</span>.Call(mockEmployee.LastName).Return(<span             style="color:#A31515">&quot;Richardson&quot;</span>).Repeat.Any();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mocks.ReplayAll();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">string</span>         actual = mockEmployee.GetNameFormatted();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mocks.VerifyAll();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2B91AF">Assert</span>.AreEqual(<span             style="color:#A31515">&quot;Richardson, Lee&quot;</span>, actual);<br />        }</span></p>

<p>And then if you're like me you absolutely hate your unit tests.  Because let alone that you had to modify your production code to accommodate unit testing, more importantly your unit tests are now unreadable.  All of them.  Even in simple methods without dependencies your unit tests contain almost as much plumbing code as actual test code.  Enter sporm.</p>

<p><b>Unmocking with Sporm</b></p>

<p>Sporm is an open source tool released on codeplex that was developed by fellow <a href="http://www.nearinfinity.com/">Near Infinity</a> employee <a href=" http://www.nearinfinity.com/blogs/joe_ferner/ ">Joe Ferner</a> (who, incidentally, is one of the most brilliant developers I know).  While this is a version 1.0 product Joe has been using it on his project and independently I've been using it on my project for several months now, so it is relatively mature.</p>

<p>So how it works is that at design time sporm will read from your SharePoint site and generate partial classes for each of your list items and each of your content types.  The generated classes don't inherit from anything, giving you the ability architect your solution how you see fit.  And the properties are auto-properties, making the classes just pure POCO.  Here's an example if you're interested:</p>

<p>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">[<span style="color:#2B91AF">SPOrmContentType</span>(Name=<span             style="color:#A31515">&quot;Employee&quot;</span>)]<br />        <span style="color:blue">public</span> <span style="color:blue">partial</span>        <span style="color:blue">class</span> <span style="color:#2B91AF">Employee</span>         : <span style="color:#2B91AF">ISPOrmContentType</span> {<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">public</span>        <span style="color:blue">static</span> <span style="color:blue">class</span>        <span style="color:#2B91AF">FieldTitles</span> {<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">public</span>        <span style="color:blue">const</span> <span style="color:blue">string</span>         FirstName = <span style="color:#A31515">&quot;First Name&quot;</span>;<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br />        <br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">public</span>        <span style="color:blue">static</span> <span style="color:blue">class</span>        <span style="color:#2B91AF">FieldStaticName</span> {<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">public</span>        <span style="color:blue">const</span> <span style="color:blue">string</span>         FirstName = <span style="color:#A31515">&quot;FirstName&quot;</span>;<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br />        <br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[<span style="color:#2B91AF">SPOrmIdField</span>()]<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">public</span>        <span style="color:blue">virtual</span> <span style="color:blue">int</span> Id {        <span style="color:blue">get</span>; <span style="color:blue">set</span>; }<br />        <br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[<span style="color:#2B91AF">SPOrmField</span>(Title         = <span style="color:#2B91AF">FieldTitles</span>.FirstName, StaticName =        <span style="color:#2B91AF">FieldStaticName</span>.FirstName)]<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">public</span>      <span style="color:blue">virtual</span> <span style="color:blue">string</span>         FirstName { <span style="color:blue">get</span>; <span style="color:blue">set</span>;         }<br />        }<br style="mso-special-character:line-break" />        <![if !supportLineBreakNewLine]>        <br style="mso-special-character:line-break" />        <![endif]></span>    </p>

<p>Since generated entities look like that, your entities can now look like this:</p>

<p>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:blue;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">public</span><span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> <span style="color:blue">partial</span>        <span style="color:blue">class</span> <span style="color:#2B91AF">Employee</span>         {<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">public</span>        <span style="color:blue">string</span> GetNameFormatted() {<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">bool</span>         noFirst = <span style="color:blue">string</span>.IsNullOrEmpty(FirstName);<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">bool</span>         noLast = <span style="color:blue">string</span>.IsNullOrEmpty(LastName);<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">...<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br />        }</span></p>

<p>Now if that isn't a picture of beauty to you then you haven't been working with SharePoint.  But wait, I hear you asking, how does this have anything to do with SharePoint?  How would an instance of an employee be able to retrieve the data in a SharePoint ListItem?  The answer is in the DataContext.  In your production code you write something like this:</p>

<p>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;color:blue;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">public</span><span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> <span style="color:blue">static</span>         Employee FindById(<span style="color:blue">int</span> id) {<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span>        <span style="color:#2B91AF">MySPDataContext<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>.GetCurrent()<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>.GetList&lt;TList&gt;()<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>.OfType&lt;TContentType&gt;()<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>.FirstOrDefault(c =&gt; c.Id ==         id);<br />        }</span></p>

<p>While it might not look so pretty at first you can hide these details in a base type and the nice thing is that it does handle SharePoint's ability to have multiple content types per list (which LINQ to SharePoint does not do, incidentally).  But for now all you need to know is that when you return an Employee thorugh MySPDataContext it subtypes your Employee class and returns you a proxy at runtime.  The proxy overrides each property to return you the appropriate value in the SPListItem.  And if you instantiate an Employee directly (as you would in unit testing) then you can use it like a pure POCO.  If you're familiar with the entity framework this should sound extremely similar.  The result is that you can write your unit tests like this:</p>

<p>        <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes">[<span style="color:#2B91AF">TestMethod</span>]<br />        <span style="color:blue">public</span> <span style="color:blue">void</span>         TestGetNameFormatted_FirstAndLastExist_CommaSeparate() {<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2B91AF">Employee</span>         employee = <span style="color:blue">new</span> <span style="color:#2B91AF">        Employee</span> {<br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FirstName =        <span style="color:#A31515">&quot;Lee&quot;</span>,        <br />        <span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>LastName =        <span style="color:#A31515">&quot;Richardson&quot;<br />        </span><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>};<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">string</span>         actual = employee.GetNameFormatted();<br />        <span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2B91AF">Assert</span>.AreEqual(<span             style="color:#A31515">&quot;Richardson, Lee&quot;</span>, actual);<br />        }</span></p>

<p>No SharePoint dependencies.  No mocking.  Nothing but pure, unadulterated unit test.  Now that a thing of beauty.</p> 
