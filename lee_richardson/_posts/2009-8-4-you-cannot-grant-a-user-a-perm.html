--- 
permalink: /blogs/lee_richardson/you_cannot_grant_a_user_a_perm.html
layout: blogs
title: You cannot grant a user a permission level that is not attached to a web
date: 2009-08-04 17:09:31 -04:00
tags: .NET
---
{% raw %}
<p>If you receive this error message that looks like this:<p>
<p>
Microsoft.SharePoint.SPException: You cannot grant a user a permission level that is not attached to a web.<br/>
&nbsp;&nbsp;at Microsoft.SharePoint.SPRoleDefinitionBindingCollection.AddInternal(SPRoleDefinition roleDefinition)<br/>
&nbsp;&nbsp;at Microsoft.SharePoint.SPRoleDefinitionBindingCollection.Add(SPRoleDefinition roleDefinition)<br/>
</p>
<p>When you're doing something like this:</p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:normal;mso-layout-grid-align:none;text-autospace:none">  <span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;color:blue;mso-no-proof:yes">private</span><span    style="font-size:10.0pt;font-family:&quot;Courier New&quot;;mso-no-proof:yes">  <span style="color:blue">static</span> <span style="color:#2B91AF">  SPRoleDefinition</span> FindAddEditListItemsRoleDefinition(<span    style="color:#2B91AF">SPWeb</span> site) {<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>  <span style="color:#2B91AF">SPRoleDefinition</span> definition =   site.RoleDefinitions<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</span>.Cast&lt;<span    style="color:#2B91AF">SPRoleDefinition</span>&gt;()<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</span>.FirstOrDefault(def   =&gt; def.Name == ROLE_DEFINITION_TITLE);<br />  <br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>  <span style="color:blue">if</span> (definition != <span style="color:blue">null</span>)  <span style="color:blue">return</span> definition;<br />  <br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>definition =  <span style="color:blue">new</span> <span style="color:#2B91AF">SPRoleDefinition</span>   {<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</span>Name =   ROLE_DEFINITION_TITLE,<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</span>Description =  <span style="color:#A31515">&quot;Can view and edit list items only.&quot;</span>,<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</span>BasePermissions =  <span style="color:#2B91AF">SPBasePermissions</span>.EditListItems<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>|  <span style="color:#2B91AF">SPBasePermissions</span>.ViewListItems<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>|  <span style="color:#2B91AF">SPBasePermissions</span>.ViewFormPages<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>|  <span style="color:#2B91AF">SPBasePermissions</span>.ViewPages<o:p></o:p></span></p> <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"> <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>| <span style="color:#2B91AF"> SPBasePermissions</span>.Open<br /> <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</span>};<br /> <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>site.RoleDefinitions.BreakInheritance(<span   style="color:blue">true</span>, <span style="color:blue">true</span>);<br /> <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>site.RoleDefinitions.Add(definition);<br /> <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>site.Update();<br /> <span style="color:green"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span> <span style="color:blue">return</span> definition;<br /> }</span>

<p>It may be because SharePoint doesn't allow you to use the SPRoleDefinition you just created and you have to return the one you just added.  Stupid, but hopefully it will help someone somewhere.</p>

<p>  <span style="font-size:10.0pt;line-height:115%;font-family:&quot;Courier New&quot;;mso-fareast-font-family:Calibri;mso-fareast-theme-font:minor-latin;mso-ansi-language:EN-US;mso-fareast-language:EN-US;mso-bidi-language:AR-SA;mso-no-proof:yes"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>...<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>site.Update();<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:green">// you can&#39;t   just return definition because SharePoint gives you  <br />  </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:green">//<span    style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>&quot;You cannot grant a user a permission   level that is not<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>//<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;  </span>attached to a web&quot; when you attempt to use it, so  <br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>//<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;  </span>you need to return it again<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="color:blue">return</span>   site.RoleDefinitions<br />  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:green">  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>.Cast&lt;<span    style="color:#2B91AF">SPRoleDefinition</span>&gt;()<br />  <span style="color:green"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span>  <span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;</span>.First(def =&gt; def.Name ==   ROLE_DEFINITION_TITLE);<br />  }</span></p> 
{% endraw %}
