--- 
permalink: /blogs/exporting_an_extjs_gridpanel_t.html
layout: blogs
title: Exporting an ExtJs GridPanel to Word XML
date: 2011-03-06 16:43:27 -05:00
tags: JavaScript Ruby Web Development
---
This blog post will lay out some of steps for exporting an ExtJs GridPanel to Word XML.&nbsp; This is useful if you want to save or print what's currently displayed in the grid.&nbsp; I am writing a subsequent post with steps on how to actually generate a Word XML file, but for now I'll focus on defining a grid, getting the grid's state, sending the grid's state to a controller, and prompting the user to save the generated Word XML document.<br /><br />Technologies used:<br />- Ruby on Rails<br />- mod_xsendfile for Apache2/Apache2.2<br />- ExtJs<br />- javascript<br /><br />At a high level, the following happens:<br />1. Gather and send the GridPanel state/configuration to the controller.<br />2. The controller runs a query and generates Word XML based on the query results.<br />3. The Word XML file is presented to the user via an "Open/Save As" dialog using XSendFile.<br /><br /><font style="font-size: 1.25em;"><b>Section 1: Getting the current state/configuration of the GridPanel</b></font><br /><br />If you're familiar with ExtJs GridPanel's you know they can be configured by each user viewing the panel.&nbsp; Columns can be added, removed, grouped, shortened, lengthened and repositioned.&nbsp; To capture the GridPanel's current state and pass it to the exporter, I wrote the following javascript.&nbsp; It calculates and returns an array containing the column order, which column data indexes belong to which titles, the grouped field (if any), the sorted field, the sorted direction, and the widths of each column.&nbsp; You will see where this function is used when I define the GridPanel in the next section.<br /><br /><br />
<pre class="prettyprint">var prepareExport = function(gridStore, gridColumnModel) {<br />&nbsp;&nbsp;&nbsp; var sort = null;<br />&nbsp;&nbsp;&nbsp; var direction = null;<br />&nbsp;&nbsp;&nbsp; if (gridStore.getSortState()) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; sort = gridStore.getSortState().field();<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; direction = gridStore.getSortState().direction;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; var columnOrder = []; //ordered list of columns reflecting the GridPanel's state<br />&nbsp;&nbsp;&nbsp; var columnsToTitles = {}; //map of ext field mappings to column titles<br />&nbsp;&nbsp;&nbsp; var columnsToWidths = {}; //width of each column<br />&nbsp;&nbsp;&nbsp; var totalWidth = 0;<br />&nbsp;&nbsp;&nbsp; var groupByField = gridStore.groupField; //the store's current grouping field ('false' if not grouped)<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; var storeReaderMapping = gridStore.fields.items;<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; //check to see if the groupField has a corresponding mapping<br />&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; gridReaderMapping.length; i++) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (gridReaderMapping[i].name == gridStore.groupField &amp;&amp; gridReaderMapping[i].mapping != null) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; groupByField = gridReaderMapping[i].mapping;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; //get the total width of the displayed columns (this will be used later when generating the Word XML)<br />&nbsp;&nbsp;&nbsp; gridColumnModel.getColumnsBy(function(c) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (!c.hidden) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; totalWidth = totalWidth + c.width;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; });<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; //iterate over the grid's column model.&nbsp; For displayed columns, get the ext field names (mappings) and column titles<br />&nbsp;&nbsp;&nbsp; gridColumnModel.getColumnsBy(function(c) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (!c.hidden) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; gridReaderMapping.length; i++) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (gridReaderMapping[i].name == c.dataIndex &amp;&amp; gridReaderMapping[i].mapping == null) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; columnOrder.push(gridReaderMapping[i].name);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var key = gridReaderMapping[i].name;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; columnsToTitles[key] = c.header;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; columnsToWidths[key] = c.width/totalWidth;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else if (gridReaderMapping[i].name == c.dataIndex &amp;&amp; gridReaderMapping[i].mapping != null) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; //if the name and mapping are different (i.e. a mapping exists), we need to push the mapping and not the name<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; columnOrder.push(gridReaderMapping[i].mapping);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var key = gridReaderMapping[i].mapping;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; columnsToTitles[key] = c.header;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; columnsToWidths[key] = c.width/totalWidth;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; });<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; return [columnOrder, columnsToTitles, groupByField, sort, direction, columnsToWidths];<br />};</pre><br /><br /><br /><font style="font-size: 1.25em;"><b>Section 2: The GridPanel</b></font><br /><br />Here's a basic ExtJs GridPanel.&nbsp; Note the "exportButton" is defined in Section 3.<br /><br /><pre class="prettyprint">var gridReaderMapping = [<br />&nbsp;&nbsp;&nbsp; {name: 'id'},<br />&nbsp;&nbsp;&nbsp; {name: 'col_one'},<br />&nbsp;&nbsp;&nbsp; {name: 'col_two', mapping: 'some_mapping'},<br />&nbsp;&nbsp;&nbsp; {name: 'col_three'}<br />];<br /><br />var gridColumnModel = new Ext.grid.ColumnModel({<br />&nbsp;&nbsp;&nbsp; defaults: {sortable: true},<br />&nbsp;&nbsp;&nbsp; columns: [<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {header: 'ID', dataIndex: 'id'},<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {header: 'Column One', dataIndex: 'col_one'},<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {header: 'Column Two', dataIndex: 'col_two'},<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {header: 'Column Three', dataIndex: 'col_three'}<br />&nbsp;&nbsp;&nbsp; ]<br />});<br /><br />var store = new Ext.data.GroupingStore({<br />&nbsp;&nbsp;&nbsp; proxy: new Ext.dataHttpProxy({<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; url: 'give/me/my/data'<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; method: 'GET'<br />&nbsp;&nbsp;&nbsp; }),<br />&nbsp;&nbsp;&nbsp; reader: new Ext.data.JsonReader({<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; root: 'data',<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; totalProperty: 'total',<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; messageProperty: 'message'<br />&nbsp;&nbsp;&nbsp; }, gridReaderMapping)<br />});<br /><br />var grid = new Ext.grid.GridPanel({<br />&nbsp;&nbsp;&nbsp; id: 'gridpanel',<br />&nbsp;&nbsp;&nbsp; ds: gridStore,<br />&nbsp;&nbsp;&nbsp; cm: gridColumnModel,<br />&nbsp;&nbsp;&nbsp; sm: new Ext.grid.RowSelectionModel({<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; singleSelect: true<br />&nbsp;&nbsp;&nbsp; }),<br />&nbsp;&nbsp;&nbsp; tbar: [exportButton],<br />&nbsp;&nbsp;&nbsp; view: etc, etc, etc, etc...<br />});</pre><br /><br /><font style="font-size: 1.25em;"><b>Section 3: The Export Button</b></font><br /><br />When the export button is clicked it gathers all the necessary data from the GridPanel (columns, widths, etc) and passes that data along with query parameters to the controller.&nbsp; The controller runs a query and generates the Word XML file.&nbsp; Section 4 describes what happens when the Ajax request returns the data successfully.<br /><br />As I said at the beginning of this post, I will follow on with another post about the actual Word XML generation.&nbsp; The Word XML generation isn't too scary.&nbsp; If you're impatient, here are a few tips on Word XML generation.<br />&nbsp;&nbsp;&nbsp; 1. You can start by creating a small Word XML file with a single table using MS Word or Open Office.&nbsp; <br />&nbsp;&nbsp;&nbsp; 2. Open the XML file with the XML viewer/editor of your choice.&nbsp; Your table will be buried somewhere between &lt;w:body&gt; and &lt;/w:body&gt;.&nbsp; All the other sections of the XML can remain the same.&nbsp; <br />&nbsp;&nbsp;&nbsp; 3. You can create a series of templates for Word XML tables and rows based on the patterns you see in your Word XML sample.<br />&nbsp;&nbsp;&nbsp; 4. In your Word XML generator, substitute values into these templates to build tables.<br />&nbsp;&nbsp;&nbsp; 5. Insert the generated templates into a "master" template. <br /><br /><pre class="prettyprint">var exportButton = new Ext.Button({<br />&nbsp;&nbsp;&nbsp; renderTo: this.wrap,<br />&nbsp;&nbsp;&nbsp; listeners: {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; click: function (node, event) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var exportConfig = prepareExport(grid.getStore(), grid.getColumnModel());<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Ext.Ajax.request({<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; url: 'url/to/query/for/data'<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; params: {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'columnsToTitles': Ext.util.JSON.encode(exportConfig[1]),<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'columnsToWidths': Ext.util.JSON.encode(exportConfig[5]),<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'columnOrder[]': exportConfig[0],<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'groupByExport': exportConfig[2],<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'groupBy': gridStore.groupField,<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'groupDir': 'ASC',<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'sort': exportConfig[3],<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'dir': exportConfig[4],<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'export': true<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'query': build_some_query_params_to_pass_to_the_controller<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; success: function(response, opts) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; window.location.href = 'path/to/exporter_controller/export_word_XML'<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; failure: function(response, opts) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; //output error message<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; scope: this<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }); <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />});</pre><br /><br /><font style="font-size: 1.25em;"><b>Section 4:&nbsp; Downloading the Word XML</b></font><br /><br />Using XSendFile to prompt the user with an "Open/Save As" dialog box.<br /><br /><pre class="prettyprint">class ExportController &lt; ApplicationController<br />&nbsp;&nbsp;&nbsp; def export_word_XML<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; filename = "#{X_SENDFILEPATH}/word_doc.xml"<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (File.exist?(filename))<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; send_file filename, :x_sendfile =&gt; true<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; render :nothing =&gt; true<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end<br />&nbsp;&nbsp;&nbsp; end<br />end</pre><br />Stay tuned for the upcoming Word XML <b><i>generation</i></b> blog post!<br /> 
<br />
