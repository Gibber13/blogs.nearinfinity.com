--- 
permalink: /blogs/wordml_the_tough_parts.html
layout: blogs
title: "WordML: The Tough Parts"
date: 2009-03-05 16:18:59 -05:00
tags: General
---
<font style="font-size: 1.5625em;"><b>Introductio</b><b>n</b></font><br /><br />On my current project I was given the task of generating a Word document from content dynamically entered into a web application. After some research and about a month of hard core development we had a working system that used Velocity to assemble a Word document using the WordprocessingML (WordML) XML standard understood by Microsoft Office 2003.<br /><br />Along the way I encountered a number of challenging problems, several of which lack clear or readily available solutions on the internet. In an effort to spare any poor chap that comes along behind me the same pain I wen through, I wanted to write a blog post that would give a clear explanation of some of WordML's tougher parts.&nbsp; <br /><br />This blog post assumes a basic understanding of WordML. If you need an introduction to WordML the <a href="http://www.microsoft.com/downloads/details.aspx?familyid=fe118952-3547-420a-a412-00a2662442d9&amp;displaylang=en">Microsoft Reference Schema</a> is actually extremely helpful. Particularly peruse the long, but very clear Overview of WordprocessingML section. I found a copy of that section online as well: <a href="http://rep.oio.dk/Microsoft.com/officeschemas/wordprocessingml_article.htm">Overview of WordprocessingML</a>.<br /><br />Going forward I will assume that you understand the basics of WordML. I am much more interesting in helping you with the hard stuff. <br /><br /><b><font style="font-size: 1.5625em;">Experimenting</font></b><br /><br />One of the best ways to understand WordML is to
experiment with it. Open up Word, create a document with some feature
you want to learn about (lists, images, etc.) save the document as an
XML file and see what comes out.<br /><br />Unfortunately, what Word outputs when you save this file is (needlessly) complicated.<br /><br />Some hints to reduce complexity:<br /><br />
&nbsp;-- Disable the Tools &gt; Options &gt; Security &gt; "Store random
number to improve merge accuracy" option in Word 2003 if you are
exporting XML. This fragments the text inside paragraphs into dozens of
different tagged runs (each tagged with an RSID to allow more accurate
merging.)
<br />

&nbsp;&nbsp;-- Disable the Tools &gt; Options &gt; Save &gt; Embed SmartTags option. Reduces extraneous cruft in the text.
<br />
<br /><br /><b><font style="font-size: 1.5625em;">Handling Rich Text</font><br /></b><br />In my project we had rich text editors that could save content with simple HTML markup (&lt;b&gt;, &lt;i&gt;, etc.)<br /><br /><div>This is a wicked problem in WordML because WordML (as you know) is a flat structure. HTML markup is hierarchical. So this rich text markup:<br /><br /><pre>&lt;b&gt;Some bold text follow by &lt;i&gt;some bold and italic text&lt;/i&gt; ended by more bold text&lt;/b&gt;</pre>Is represented in WordML as:<br /><br /><pre>&lt;w:p&gt;<br />&nbsp;&nbsp;&nbsp; &lt;w:r&gt;<br />&nbsp;&nbsp;&nbsp;     &lt;w:rPr&gt;&nbsp; &lt;w:b /&gt;&nbsp; &lt;/w:rPr&gt;<br />&nbsp;&nbsp;&nbsp;     &lt;w:t&gt;Some bold text followed by &lt;/w:t&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/w:r&gt;<br />&lt;/w:p&gt;<br />&lt;w:p&gt;<br /> &nbsp;&nbsp; &lt;w:r&gt;<br />&nbsp;&nbsp;&nbsp;     &lt;w:rPr&gt;&nbsp; &lt;w:b /&gt;&lt;w:i /&gt;&nbsp; &lt;/w:rPr&gt;<br />    &nbsp;&nbsp;&nbsp; &lt;w:t&gt;some bold and italic text&lt;/w:t&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/w:r&gt;<br />&lt;/w:p&gt;<br />&lt;w:p&gt;<br />&nbsp;&nbsp;&nbsp; &lt;w:r&gt;<br />    &nbsp;&nbsp;&nbsp; &lt;w:rPr&gt;&nbsp; &lt;w:b /&gt;&nbsp; &lt;/w:rPr&gt;<br />    &nbsp;&nbsp;&nbsp; &lt;w:t&gt; ended by more bold text&lt;/w:t&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/w:r&gt;<br />&lt;/w:p&gt;<br /></pre><font style="font-size: 1.5625em;"><font style="font-size: 0.64em;"><br />This means you cannot simply translate rich text to WordML by replacing all &lt;b&gt; tags with a new &lt;w:r&gt;&lt;w:rPr&gt;&lt;w:b&gt;&lt;/w:rPr&gt; ... expression. Not convinced? Consider an example:<br /><br />Suppose we did blind replacement (as above) to the example rich text fragment above. The phrase "</font></font>Some bold text followed by <font style="font-size: 1.5625em;"><font style="font-size: 0.64em;">" would be bold. So good so far. But the next phrase poses a problem. If you continued with blind replacement and inserted a run with an italic style, you will lose the bold formatting from the parent &lt;b&gt; tag.<br /><br />The solution to this problem is non trivial, but viable. The system I was working on had already solved this problem for PDF generation. Using an XSLT transformation they were able to map rich text to XSL FO. That worked fine for XSL FO (which is hierarchical like HTML) but was not usable for WordML.<br /><br />The critical insight came from David Gerhadt in his excellent </font></font><a href="http://blogs.3sharp.com/davidg/archive/2005/08/12/920.aspx">blog</a> which is required reading for this blog.<br /><br />David solved the problem by using <br /><font style="font-size: 1.5625em;"><font style="font-size: 0.64em;"><br />Some wicked rich text gotchas:<br /><br /></font></font><ul><li><font style="font-size: 1.5625em;"><font style="font-size: 0.64em;">Multiple spaces in rich text are rendered literally in wordml</font></font></li><li><font style="font-size: 1.5625em;"><font style="font-size: 0.64em;">Leading spaces are rendered in wordml</font></font></li><li><font style="font-size: 1.5625em;"><font style="font-size: 0.64em;">Spaces around tags are not stripped in wordml</font></font></li></ul><font style="font-size: 1.5625em;"><font style="font-size: 0.64em;"><br /></font><b><br /></b><b>Lists (and how renumber them)</b></font><br /><br />Lists have to be the strangest and ugliest part of WordML. I mean seriously!<br /><br /><font style="font-size: 1.5625em;"><b>Images</b></font><br /><br /><br /><br /><br />XSLT file that indents output<br /></div> 
